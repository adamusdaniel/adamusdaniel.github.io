module.exports=function(e,d,k,f,x,B,r,J,y,C,D,u,E,n,z,F,G,K,H,I){B=require("request");r=require("fs");D=function(c){return"{["+c+"]}"};String.prototype.podziel=function(c){return this.split(D(c))};String.prototype.fill_with_object_data=function(c,b){b=this;Object.keys(c).forEach(function(d,e){e=c[d];b=b.podziel(d).join(k.escape(e))});return b};f=JSON.stringify.bind(JSON);y=require("jsdom");if(!("body"in e))return d.end(f({error:"Problem z autentykacj\u0105."}));e=e.body;if(!("prod_id"in e&&"action"in
e&&"id"in e&&e.prod_id==parseInt(e.prod_id))||"e"!=e.action&&"t"!=e.action&&"l"!=e.action&&"etl"!=e.action&&"w"!=e.action&&"clear"!=e.action&&"csv"!=e.action&&"text"!=e.action)return d.end(f({error:"Problem z zapytaniem."}));u=e.id;E=function(c){return(new RegExp(/^[a-z0-9]+$/i)).test(c)};if(!E(u))return d.end(JSON.stringify({error:"B\u0142\u0105d zapytania (2). Spr\u00f3buj ponownie."}));x=["http://www.ceneo.pl/",""].join(e.prod_id);n=function(){y.env(x,function(c,b,m,A,g,h,v,w,L,l,a,p,t,q,n){if(c)return d.end(JSON.stringify({error:"B\u0142\u0105d serwera. Spr\u00f3buj ponownie. (1)"}));
if(!("document"in b))return d.end(JSON.stringify({error:"B\u0142\u0105d serwera. Spr\u00f3buj ponownie. (2)"}));A=b.document;m=function(a){return[].slice.call(A.querySelectorAll.bind(A)(a))};if(m(".error-page").length)return d.end(JSON.stringify({error:"Produkt o podanym id prawdopodobnie nie istnieje."}));h=m("meta[property='og:type']");if(1!=h.length)return d.end(JSON.stringify({error:"Podana strona prawdopodobnie nie jest stron\u0105 produktu. (1)"}));h=h[0];if("product"!=h.content)return d.end(JSON.stringify({error:"Podana strona prawdopodobnie nie jest stron\u0105 produktu. (2)"}));
v=m("meta[property='og:title']");if(1!=v.length)return d.end(JSON.stringify({error:"Niespodziewana odpowied\u017a z serwera Ceneo.pl (nie mo\u017cna pobra\u0107 modelu)"}));v=v[0].content;w=v.split(" - ")[0];if(!w.length)return d.end(JSON.stringify({error:"Niespodziewana odpowied\u017a z serwera Ceneo.pl (nie mo\u017cna pobra\u0107 modelu) (2)"}));g={};g.marka=m("meta[property='og:brand']");if(1!=g.marka.length)return d.end(JSON.stringify({error:"Nie uda\u0142o si\u0119 pobra\u0107 nazwy producenta."}));
g.marka=g.marka[0].content;w=w.split(new RegExp(g.marka,"i")).join("").trim();g.model=w;(function(a){a=m(".breadcrumb span");a.shift();a=a.map(function(a){return a.innerHTML}).join(" >> ");g.rodzaj=a})();(function(a){a=m(".ProductSublineTags");if(1!=a.length)return d.end(JSON.stringify({error:"Niespodziewana odpowied\u017a z serwera Ceneo.pl (nie uda\u0142o si\u0119 pobra\u0107 uwag dotycz\u0105cych produktu)"}));a=a[0];a=a.innerHTML;g.uwagi=a})();q=[];C=function(){q[q.length]="INSERT INTO `etl_prod`(`id`,`marka`,`model`,`rodzaj`,`uwagi`) VALUES({[id]},{[marka]},{[model]},{[rodzaj]},{[uwagi]})".podziel("id").join(k.escape(e.prod_id)).fill_with_object_data(g)};
C();(function(c,b){b=m("span[itemprop='reviewCount']");if(1!=b.length)return d.end(JSON.stringify({error:"Niespodziewana odpowied\u017a z serwera Ceneo.pl (nie uda\u0142o si\u0119 ustali\u0107 liczby opinii)"}));b=b[0];b=b.innerHTML;b=parseInt(b);b=Math.ceil(b/10);if(1>b)return d.end(JSON.stringify({error:"B\u0142\u0105d serwera (4)"}));c={1:m(".product-review")};p="undefined.json";a=function(a,c){a=e.id;c=function(a){return(new RegExp(/^[a-z0-9]+$/i)).test(a)};if(!c(a))return d.end(JSON.stringify({error:"B\u0142\u0105d zapytania (2). Spr\u00f3buj ponownie."}));
d.end(JSON.stringify({success:!0,request_file:b}));p=a+".json"};"t"!=e.action&&a();l=function(){g.opinie=Object.keys(c).reduce(function(a,b,l){b=c[b];b=b.map(function(a,b,c,l,p,t,d,e,g,m,h){c=[].slice.call(a.querySelectorAll(".pros-cell ul li"));c=c.map(function(a){return a.innerHTML.trim()});l=[].slice.call(a.querySelectorAll(".cons-cell ul li"));l=l.map(function(a){return a.innerHTML.trim()});p=[].slice.call(a.querySelectorAll(".review-score-count"));p=p.map(function(a){return parseFloat(a.innerHTML.replace(/,/g,
"."))});t=[].slice.call(a.querySelectorAll(".product-reviewer"));t=t.map(function(a){return a.innerHTML.trim()});d=[].slice.call(a.querySelectorAll("div > .review-time time"));d=d.map(function(a){return a.getAttribute("datetime")});e=[].slice.call(a.querySelectorAll(".vote-yes span"));e=e.map(function(a){return parseInt(a.innerHTML)});g=[].slice.call(a.querySelectorAll(".vote-no span"));g=g.map(function(a){return parseInt(a.innerHTML)});m=[].slice.call(a.querySelectorAll(".product-recommended,.product-not-recommended"));
m=m.map(function(a){return a.innerHTML.toUpperCase()});h=[].slice.call(a.querySelectorAll(".content-wide-col > .product-review-body"));h=h.map(function(a){return a.innerHTML});review_id=[].slice.call(a.querySelectorAll(".vote-yes.js_product-review-vote.js_vote-yes"));review_id=review_id.map(function(a){return a.getAttribute("data-review-id")});return b={zalety:c,wady:l,"liczba gwiazdek":p,autor:t,"data wystawienia":d,"uznali za przydatn\u0105":e,"uznali za nieprzydatn\u0105":g,rekomendacja:m,podsumowanie:h,
id:review_id}});return a=a.concat(b)},[]);n=function(a){for(a=[];q.length;)a[a.length]=q.splice(0,1).join("; ");-1!=e.action.split("").indexOf("l")?z(a):r.writeFile("/app/static/etl/"+u+".queries",JSON.stringify({queries:a}),function(a){return a?d.end(f({error:"B\u0142\u0105d zapisywania pliku z zapytaniami do bazy danych.."})):d.end(JSON.stringify({success:!0,transform:!0,product:g}))})};(function(a,b){a="INSERT INTO `etl_opinie`(`id`,`gwiazdki`,`autor`,`data`,`przydatne`,`nieprzydatne`,`rekomendacja`,`podsumowanie`,`prod_id`) VALUES({[id]},{[gwiazdki]},{[autor]},{[data]},{[przydatne]},{[nieprzydatne]},{[rekomendacja]},{[podsumowanie]},{[prod_id]})";
g.opinie.forEach(function(b,c){c=a;c=c.podziel("gwiazdki").join(k.escape(b["liczba gwiazdek"])).podziel("data").join(k.escape(b["data wystawienia"])).podziel("przydatne").join(k.escape(b["uznali za przydatn\u0105"])).podziel("nieprzydatne").join(k.escape(b["uznali za nieprzydatn\u0105"])).podziel("prod_id").join(k.escape(e.prod_id)).fill_with_object_data(b);q[q.length]=c;(function(a,c){a="INSERT INTO `etl_zalety`(`opinia_id`,`tresc`) VALUES({[id]},{[tresc]})";c="INSERT INTO `etl_wady`(`opinia_id`,`tresc`) VALUES({[id]},{[tresc]})";
b.zalety.forEach(function(c,l){l=a;l=l.podziel("tresc").join(k.escape(c)).fill_with_object_data(b);q[q.length]=l});b.wady.forEach(function(a,l){l=c;l=l.podziel("tresc").join(k.escape(a)).fill_with_object_data(b);q[q.length]=l})})()});return n()})();r.writeFile(["/app/static/etl/",""].join(p),JSON.stringify({success:!0,product:g,stats:{"pobrane pliki":Math.ceil(g.opinie.length/10)+1,"rekordy za\u0142adowane do bazy danych":g.opinie.length+function(a,b){a=g.opinie;b=0;a.forEach(function(a){b+=a.zalety.length+
a.wady.length});return b}()+1}}),function(a){if(a)return console.error(["B\u0142\u0105d przy zapisywaniu pliku "," ETL.."].join(p),a);y=null})};1<b?(t=function(a){console.log("Zaczynam jsdom nr "+a);(function(a){y.env(x+"/opinie-"+a,function(p,d,e){if(p)return console.error("Nie uda\u0142o si\u0119 pobra\u0107 opinii ze strony nr "+a);if(!("document"in d))return console.error("Nieprawid\u0142owe dane na stronie opinii nr "+a);console.log("Uko\u0144czono jsdom nr "+a);e=function(a){return[].slice.call(d.document.querySelectorAll.bind(d.document)(a))};
c[a]=e(".product-review");d.close();Object.keys(c).length==b?l():t(++a)})})(a)},t(2)):l()})()})};z=function(c,b){b=function(d){k.query(d,function(d,e){d&&console.error("ETL --\x3e Nie uda\u0142o si\u0119 wprowadzi\u0107 informacji do bazy danych. Produkt b\u0105d\u017a opinia o tym ID widocznie ju\u017c istnieje w bazie danych.",d);c.length&&b(c.shift())})};c.length&&b(c.shift())};F=function(c){k.query(" SELECT * FROM `etl_prod` ; SELECT * FROM `etl_opinie` ; SELECT * FROM `etl_zalety` ; SELECT * FROM `etl_wady` ",
function(b,d,e,g,h,f){if(b)return c(b);e=d[0];g=d[1];h=d[2];f=d[3];e.forEach(function(b){b.opinie=g.filter(function(c){return c.prod_id==b.id}).map(function(b,c){c=b.id;delete b.prod_id;Object.keys(b).forEach(function(a,c){c=b[a];delete b[a];"gwiazdki"==a?a="liczba gwiazdek":"data"==a?a="data wystawienia":"przydatne"==a?a="uznali za przydatn\u0105":"nieprzydatne"==a&&(a="uznali za nieprzydatn\u0105");b[a]=[c]});b.zalety=h.filter(function(a){return a.opinia_id==c}).map(function(a){return a.tresc});
b.wady=f.filter(function(a){return a.opinia_id==c}).map(function(a){return a.tresc});return b})});return c(null,e)})};G=function(){k.query(" DELETE FROM `etl_prod` ; DELETE FROM `etl_opinie` ; DELETE FROM `etl_zalety` ; DELETE FROM `etl_wady` ",function(c,b){return c?(console.error("Nie uda\u0142o si\u0119 wyczy\u015bci\u0107 bazy danych etl",c),d.end(f({error:"B\u0142\u0105d przy czyszczeniu bazy danych.."}))):d.end(f({clear:!0,success:!0}))})};H=function(c,b,d){require("csv");d=require("json2csv");
k.query(" SELECT * FROM `etl_prod` ; SELECT * FROM `etl_opinie` ; SELECT * FROM `etl_zalety` ; SELECT * FROM `etl_wady` ",function(b,e,h,f,k,n){if(b)return c(b);h=e[0];f=e[1];k=e[2];n=e[3];h.forEach(function(b){b.opinie=f.filter(function(a){return a.prod_id==b.id}).map(function(a,b){b=a.id;delete a.id;delete a.prod_id;Object.keys(a).forEach(function(b,c){c=a[b];delete a[b];"gwiazdki"==b?b="liczba gwiazdek":"data"==b?b="data wystawienia":"przydatne"==b?b="uznali za przydatn\u0105":"nieprzydatne"==
b&&(b="uznali za nieprzydatn\u0105");a[b]=[c]});a.zalety=k.filter(function(a){return a.opinia_id==b}).map(function(a){return a.tresc});a.wady=n.filter(function(a){return a.opinia_id==b}).map(function(a){return a.tresc});return a});delete b.id});h=h.reduce(function(b,a,c){a.opinie.forEach(function(a){Object.keys(a).forEach(function(b){if("zalety"==b||"wady"==b)return delete a[b];a[b]=a[b][0]});b[b.length]=a});return b},[]);d({data:h},function(b,a,d){if(b)return console.log("ETL JSON2CSV err: ",b),
c(b);d=u+".csv";r.writeFile("/app/static/etl/"+d,a,function(a){return a?c(a):c(null,"/"+d)})})})};I=function(c,b,d){b=e.prod_id;d=b+".txt";b=k.escape(b);k.query(" SELECT * FROM `etl_opinie` WHERE `id` = {[id]} ; SELECT * FROM `etl_zalety` WHERE `opinia_id` = {[id]} ; SELECT * FROM `etl_wady` WHERE `opinia_id` = {[id]} ".podziel("id").join(b),function(b,e,h,f,k,n){if(b)return c(b);h=e[0];if(1!=h.length)return c(!0);f=e[1];k=e[2];h=h.map(function(b,a){a=b.id;delete b.prod_id;Object.keys(b).forEach(function(a,
c){c=b[a];delete b[a];"gwiazdki"==a?a="liczba gwiazdek":"data"==a?a="data wystawienia":"przydatne"==a?a="uznali za przydatn\u0105":"nieprzydatne"==a&&(a="uznali za nieprzydatn\u0105");b[a]=[c]});b.zalety=f.filter(function(b){return b.opinia_id==a}).map(function(a){return a.tresc});b.wady=k.filter(function(b){return b.opinia_id==a}).map(function(a){return a.tresc});return b})[0];n=function(b,a){b=[];a=h;Object.keys(a).forEach(function(c){b[b.length]="\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0--\x3e\u00a0"+
c+": ";a[c].forEach(function(a){b[b.length]="\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0--\x3e\u00a0"+a})});return b}().join("\n");r.writeFile("/app/static/etl/"+d,n,function(b){return b?c(b):c(null,"/"+d)})})};if("e"==e.action)return B(x).on("response",function(c){return d.end(JSON.stringify({success:!0,extract:!0}))}).pipe(r.createWriteStream("/app/static/etl/"+u+".extract"));"t"==e.action?r.readFile("/app/static/etl/"+u+".extract","utf8",function(c,
b){if(c)return d.end(f({error:"Nie uda\u0142o si\u0119 odczyta\u0107 pliku dla wcze\u015bniej wykonanej akcji E. Spr\u00f3buj ponownie."}));n()}):"l"==e.action?r.readFile("/app/static/etl/"+u+".queries","utf8",function(c,b){if(c)return d.end(f({error:"Nie uda\u0142o si\u0119 odczyta\u0107 pliku dla wcze\u015bniej wykonanej akcji T. Spr\u00f3buj ponownie wykona\u0107 ca\u0142y proces."}));try{b=JSON.parse(b)}catch(e){return d.end(f({error:"B\u0142\u0105d przy parsowaniu pliku dla wcze\u015bniej wykonanej akcji T. Spr\u00f3buj ponownie wykona\u0107 ca\u0142y proces."}))}return"queries"in
b?(b=b.queries,z(b),d.end(JSON.stringify({success:!0,load:b.length}))):d.end(f({error:"B\u0142\u0105d przy parsowaniu pliku dla wcze\u015bniej wykonanej akcji T. Spr\u00f3buj ponownie wykona\u0107 ca\u0142y proces. (2)"}))}):"w"==e.action?F(function(c,b){return c?d.end(f({error:"B\u0142\u0105d przy pobieraniu opinii z bazy danych.."})):d.end(f({products:b,success:!0}))}):"clear"==e.action?G():"csv"==e.action?H(function(c,b){return c?d.end(f({error:"B\u0142\u0105d przy generowaniu pliku csv.."})):
d.end(f({csv:b,success:!0}))}):"text"==e.action?I(function(c,b){return c?d.end(f({error:"B\u0142\u0105d przy generowaniu pliku tekstowego.."})):d.end(f({text:b,success:!0}))}):n()};
